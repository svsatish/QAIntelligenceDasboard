# Azure Pipelines - Test Automation Dashboard
# This pipeline builds and deploys the dashboard to Azure Static Web Apps
#
# Prerequisites:
# 1. Create an Azure Static Web App in Azure Portal
# 2. Copy the deployment token from Azure Portal
# 3. Create a variable group in Azure DevOps with AZURE_STATIC_WEB_APPS_API_TOKEN
#
# For other deployment options (Blob Storage, App Service), see README.md

trigger:
  branches:
    include:
      - main
      - master
  paths:
    exclude:
      - README.md
      - ONBOARDING.md
      - docs/*

pr:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: 'dashboard-variables'  # Contains AZURE_STATIC_WEB_APPS_API_TOKEN
  - name: nodeVersion
    value: '18.x'
  - name: buildConfiguration
    value: 'production'

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: Build
        displayName: 'Build Dashboard'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js $(nodeVersion)'
            inputs:
              versionSpec: '$(nodeVersion)'

          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(System.DefaultWorkingDirectory)/node_modules

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm run lint --if-present
            displayName: 'Run linting'
            continueOnError: true

          - script: npm run test --if-present
            displayName: 'Run tests'
            continueOnError: true

          - script: npm run build
            displayName: 'Build production bundle'
            env:
              NODE_ENV: production

          - task: PublishBuildArtifacts@1
            displayName: 'Publish build artifacts'
            inputs:
              PathtoPublish: 'dist'
              ArtifactName: 'dashboard-dist'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'Deploy Stage'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: Deploy
        displayName: 'Deploy to Azure Static Web Apps'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: dashboard-dist
                  displayName: 'Download build artifacts'

                - task: AzureStaticWebApp@0
                  displayName: 'Deploy to Azure Static Web Apps'
                  inputs:
                    app_location: '$(Pipeline.Workspace)/dashboard-dist'
                    skip_app_build: true
                    azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN)

# Alternative: Deploy to Azure Blob Storage
# Uncomment below and comment out the AzureStaticWebApp task above
#
#                - task: AzureCLI@2
#                  displayName: 'Deploy to Azure Blob Storage'
#                  inputs:
#                    azureSubscription: 'Your-Azure-Service-Connection'
#                    scriptType: 'bash'
#                    scriptLocation: 'inlineScript'
#                    inlineScript: |
#                      az storage blob upload-batch \
#                        --account-name $(storageAccount) \
#                        --destination '$web' \
#                        --source $(Pipeline.Workspace)/dashboard-dist \
#                        --overwrite

# Alternative: Deploy to Azure App Service
# Uncomment below for App Service deployment
#
#                - task: ArchiveFiles@2
#                  inputs:
#                    rootFolderOrFile: '$(Pipeline.Workspace)/dashboard-dist'
#                    includeRootFolder: false
#                    archiveType: 'zip'
#                    archiveFile: '$(Pipeline.Workspace)/dist.zip'
#
#                - task: AzureWebApp@1
#                  inputs:
#                    azureSubscription: 'Your-Azure-Service-Connection'
#                    appType: 'webAppLinux'
#                    appName: 'your-app-name'
#                    package: '$(Pipeline.Workspace)/dist.zip'

